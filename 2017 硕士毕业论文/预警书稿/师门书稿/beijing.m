%% 该代码为基于BP神经网络的预测算法
%
% <html>
% <table border="0" width="600px" id="table1">	<tr>		<td><b><font size="2">该案例作者申明：</font></b></td>	</tr>	<tr><td><span class="comment"><font size="2">1：本人长期驻扎在此<a target="_blank" href="http://www.ilovematlab.cn/forum-158-1.html"><font color="#0000FF">板块</font></a>里，对该案例提问，做到有问必答。本套书籍官方网站为：<a href="http://video.ourmatlab.com">video.ourmatlab.com</a></font></span></td></tr><tr>		<td><font size="2">2：点此<a href="http://union.dangdang.com/transfer/transfer.aspx?from=P-284318&backurl=http://www.dangdang.com/">从当当预定本书</a>：<a href="http://union.dangdang.com/transfer/transfer.aspx?from=P-284318&backurl=http://www.dangdang.com/">《Matlab神经网络30个案例分析》</a>。</td></tr><tr>	<td><p class="comment"></font><font size="2">3</font><font size="2">：此案例有配套的教学视频，视频下载方式<a href="http://video.ourmatlab.com/vbuy.html">video.ourmatlab.com/vbuy.html</a></font><font size="2">。 </font></p></td>	</tr>			<tr>		<td><span class="comment"><font size="2">		4：此案例为原创案例，转载请注明出处（《Matlab神经网络30个案例分析》）。</font></span></td>	</tr>		<tr>		<td><span class="comment"><font size="2">		5：若此案例碰巧与您的研究有关联，我们欢迎您提意见，要求等，我们考虑后可以加在案例里。</font></span></td>	</tr>		</table>
% </html>
%% 清空环境变量
clc
clear

%% 训练数据预测数据提取及归一化
beijing_data=[23.51 	77.40 	1585.00 	148.80 	277096.74 	6.45 	29.73 	32207770.00 	99.70 	1964.97 	470.12 	2791.31 	9022.00 	104.80 
21.16 	20.22 	1570.00 	148.80 	283948.94 	8.30 	26.66 	25619052.00 	100.15 	1802.19 	194.45 	379.88 	8720.00 	105.29 
24.79 	73.00 	1704.00 	132.00 	464778.54 	7.50 	23.90 	33109033.00 	99.97 	2129.87 	159.42 	762.28 	10053.00 	105.46 
25.28 	96.30 	1891.00 	123.00 	337367.05 	5.00 	12.85 	32063359.00 	100.30 	1856.52 	338.82 	1162.30 	11506.00 	105.85 
25.63 	92.60 	1567.00 	134.00 	249713.52 	7.50 	12.23 	32232254.00 	100.80 	1888.14 	278.39 	1656.74 	11356.00 	105.51 
16.79 	75.40 	1603.00 	230.00 	235247.72 	7.60 	18.77 	30103562.00 	100.20 	2084.96 	212.83 	2201.20 	11009.00 	106.25 
23.10 	77.50 	1695.00 	113.00 	358441.91 	4.80 	25.86 	30986342.00 	99.96 	1907.13 	285.23 	2703.46 	11063.00 	106.41 
24.99 	83.00 	1742.00 	147.00 	326555.43 	4.00 	24.74 	34318628.00 	100.57 	1954.28 	186.57 	3253.05 	11419.00 	106.64 
31.99 	88.10 	1826.00 	146.00 	185393.82 	6.00 	17.45 	34309628.00 	99.67 	1976.14 	177.71 	3814.77 	11390.00 	106.54 
23.44 	87.60 	1832.00 	130.00 	173121.85 	5.00 	16.01 	32112207.00 	99.74 	2012.15 	326.44 	4312.81 	11144.00 	105.91 
18.45 	85.50 	1841.00 	183.00 	289457.08 	5.10 	25.12 	35652920.00 	99.62 	2026.26 	172.78 	4938.08 	11264.00 	104.62 
22.99 	72.20 	2096.64 	150.00 	185234.18 	10.10 	29.48 	36329124.00 	99.75 	1976.99 	254.80 	5519.86 	10951.09 	104.43 
20.97 	76.65 	1705.00 	174.40 	141290.59 	9.14 	33.25 	31745631.00 	99.69 	2142.67 	455.35 	2978.15 	8415.00 	104.82 
21.54 	17.50 	2003.00 	174.40 	292000.76 	24.00 	28.51 	33790646.00 	100.20 	1990.72 	194.80 	385.94 	9930.00 	103.45 
25.07 	68.20 	2438.00 	101.00 	333938.46 	7.20 	30.41 	36701824.00 	99.68 	2154.42 	207.13 	800.82 	10873.00 	103.69 
23.25 	64.50 	2282.00 	140.00 	220353.93 	4.70 	14.13 	34550566.00 	100.07 	2068.60 	328.97 	1213.82 	11792.00 	103.47 
23.95 	83.10 	2120.00 	202.00 	299008.02 	8.70 	14.64 	37901965.00 	99.53 	2102.80 	309.51 	1731.26 	11627.00 	103.19 
16.93 	73.40 	2266.00 	273.00 	231287.43 	8.30 	15.79 	33169687.00 	99.69 	2084.60 	246.61 	2335.83 	11218.00 	102.55 
20.24 	89.00 	2130.00 	120.00 	252105.86 	5.70 	23.60 	32239126.00 	99.24 	2144.12 	349.60 	2866.87 	11177.00 	102.65 
21.05 	95.80 	2248.00 	127.00 	239533.67 	7.00 	20.46 	30291894.00 	99.85 	2208.14 	222.85 	3441.05 	11434.00 	102.66 
21.82 	97.60 	2215.00 	222.00 	220364.76 	8.30 	20.01 	32829540.00 	99.87 	2202.44 	211.01 	4043.66 	11564.00 	103.04 
18.92 	96.90 	1925.00 	226.00 	173872.42 	9.70 	22.65 	31774360.00 	99.79 	2225.24 	360.47 	4628.88 	11127.00 	102.85 
18.64 	93.10 	1731.00 	165.00 	159955.98 	8.20 	33.64 	35260373.00 	99.79 	2233.53 	206.61 	5247.34 	11305.00 	103.23 
19.31 	64.10 	2210.64 	168.00 	267060.06 	8.70 	33.71 	38488636.00 	99.82 	2154.79 	314.28 	6064.15 	10987.55 	103.54 
18.11 	84.77 	1769.00 	145.82 	396228.77 	7.33 	27.18 	34145762.00 	99.66 	2285.71 	523.58 	3255.53 	9518.00 	103.12 
18.11 	84.77 	1383.00 	32.00 	267599.66 	7.33 	30.40 	30194748.00 	100.14 	2179.25 	224.81 	436.13 	8974.00 	104.58 
21.24 	61.00 	2455.00 	158.00 	350751.11 	5.70 	31.48 	38836901.00 	99.87 	2194.77 	219.22 	906.05 	10702.00 	103.63 
18.58 	86.57 	2587.00 	153.00 	446886.59 	7.70 	20.94 	36777723.00 	99.89 	2242.72 	401.50 	1358.91 	11845.00 	103.22 
18.70 	96.71 	2565.00 	153.00 	446886.59 	7.80 	24.22 	36621001.00 	99.28 	2294.95 	307.34 	1865.49 	11631.00 	102.73 
18.58 	79.90 	2511.00 	224.00 	298872.09 	6.40 	19.46 	34150158.00 	99.64 	2259.29 	287.30 	2517.40 	11504.00 	103.55 
10.70 	84.00 	2299.00 	102.00 	444383.64 	8.10 	27.78 	38134819.00 	99.79 	2307.48 	389.40 	3085.75 	11303.00 	103.32 
19.40 	91.90 	2409.00 	91.00 	438827.73 	7.30 	34.80 	36489851.00 	99.94 	2342.31 	224.20 	3725.51 	11429.00 	102.69 
18.30 	84.80 	2495.00 	197.00 	396814.70 	8.60 	19.71 	37755685.00 	100.09 	2353.32 	228.17 	4410.60 	11461.00 	103.27 
18.60 	95.20 	2084.00 	152.00 	424813.37 	7.50 	18.91 	34783456.00 	99.87 	2381.91 	414.90 	4970.30 	11237.00 	103.42 
18.00 	96.20 	1760.00 	208.00 	394086.38 	7.80 	32.77 	32710184.00 	99.81 	2370.51 	236.70 	5737.11 	11259.00 	103.31 
19.00 	71.40 	2125.27 	134.00 	402670.74 	6.40 	38.47 	38209659.00 	100.02 	2216.26 	345.78 	6797.54 	4377.00 	102.72 
16.20 	65.74 	1922.00 	122.20 	427647.71 	6.00 	27.15 	39854769.51 	99.79 	2258.13 	600.25 	3419.30 	4392.00 	103.28 
16.20 	65.74 	910.00 	122.20 	481868.02 	6.00 	32.29 	33046922.73 	100.88 	2183.84 	257.39 	468.82 	3793.00 	101.79 
17.40 	58.60 	1538.00 	111.00 	429798.01 	6.00 	28.91 	36172741.84 	100.25 	2196.70 	223.46 	929.80 	4285.00 	102.12 
16.60 	77.70 	2194.00 	115.00 	339704.20 	6.70 	21.29 	36457351.95 	99.63 	2199.20 	444.94 	1452.31 	4602.00 	101.53 
18.10 	81.10 	2555.00 	106.00 	284975.31 	5.20 	21.33 	34386535.30 	99.54 	2227.90 	341.62 	2008.41 	4506.00 	102.15 
17.20 	61.70 	2453.00 	156.00 	347317.77 	7.70 	24.83 	32372175.30 	99.83 	2238.90 	314.79 	2747.32 	4582.00 	102.19 
13.70 	68.80 	2400.00 	110.00 	540795.70 	8.00 	35.47 	34409119.85 	99.86 	2258.10 	423.40 	3338.24 	4446.00 	101.83 
12.20 	66.20 	2564.00 	100.00 	579309.85 	6.00 	27.13 	32120172.64 	99.86 	2284.00 	243.59 	3991.10 	4500.00 	101.52 
17.50 	60.90 	2529.00 	144.00 	726971.76 	6.20 	16.30 	36485290.38 	99.93 	2323.60 	246.44 	4667.46 	4260.00 	101.09 
17.50 	70.10 	2266.00 	128.00 	600762.57 	6.40 	19.35 	33547754.18 	99.77 	2360.80 	467.83 	5240.55 	4217.00 	100.51 
14.20 	53.50 	2047.00 	86.00 	724329.22 	1.40 	31.34 	33191356.90 	99.86 	2367.10 	239.84 	5894.87 	4564.00 	100.71 
17.60 	58.80 	2064.73 	166.00 	1189567.48 	6.40 	40.46 	33685836.11 	99.86 	2199.30 	404.74 	6873.44 	4162.82 	100.78 
14.14 	49.94 	1955.00 	151.40 	886446.89 	0.36 	32.50 	29840950.00 	99.01 	2290.60 	683.69 	3623.73 	4152.00 	100.37 
14.14 	49.94 	1152.00 	151.40 	648426.21 	0.36 	32.52 	21974728.86 	99.79 	2247.30 	277.40 	461.88 	3643.00 	101.66 
16.70 	24.30 	1553.00 	74.00 	1656752.51 	4.50 	28.97 	26335922.58 	99.96 	2237.70 	298.49 	1007.93 	3776.00 	101.57 
13.40 	70.90 	2207.00 	73.00 	2152796.79 	(0.10)	16.58 	27235842.54 	99.66 	2268.30 	530.24 	1473.21 	3830.00 	101.96 
17.00 	63.30 	2613.00 	134.00 	2514634.73 	(0.70)	20.64 	25114308.54 	100.07 	2314.80 	425.02 	2057.54 	4735.00 	101.75 
15.20 	53.10 	2453.00 	243.00 	2825133.04 	1.70 	25.61 	28548655.76 	99.56 	2291.30 	327.92 	2848.39 	4372.00 	101.74 
12.80 	48.10 	2321.00 	88.00 	2463959.39 	(5.90)	33.86 	28614361.55 	99.61 	2303.30 	552.31 	3482.15 	4252.00 	102.28 
12.70 	37.60 	2076.00 	113.00 	1655248.14 	(1.90)	37.72 	24620819.92 	99.49 	2311.80 	304.13 	4069.96 	4297.00 	102.64 
12.60 	41.70 	2034.00 	253.00 	1038591.73 	(4.10)	32.22 	28719290.87 	99.64 	2331.80 	291.98 	4875.07 	4333.00 	102.33 
13.60 	56.70 	2204.00 	199.00 	1355462.38 	1.70 	27.79 	23941831.28 	99.75 	2374.20 	510.84 	5668.60 	4150.00 	101.90 
13.80 	53.20 	2144.00 	193.00 	2053888.17 	8.20 	50.66 	24327557.39 	99.70 	2329.20 	250.16 	6470.23 	4251.00 	101.91 
13.60 	50.50 	1667.73 	144.00 	1708435.96 	0.20 	50.96 	30683451.55 	99.50 	2186.90 	443.67 	7446.02 	3991.55 	102.03 
13.57 	46.67 	1414.00 	144.50 	1033891.15 	5.69 	34.18 	20175891.87 	99.85 	2335.50 	791.03 	3852.89 	3905.00 	101.24 
13.57 	46.67 	793.00 	144.50 	736955.40 	5.69 	34.73 	16917949.74 	99.76 	2201.60 	318.86 	517.00 	3462.00 	101.27 
13.87 	43.85 	1138.00 	118.00 	1257941.95 	6.30 	40.31 	22641685.72 	99.96 	2190.50 	318.65 	1132.17 	3827.00 	101.56 
12.29 	57.71 	1753.00 	110.00 	1297322.40 	1.90 	21.90 	21386700.70 	100.05 	2241.50 	596.01 	1645.66 	4114.00 	101.39 
12.86 	54.60 	2025.00 	130.00 	1098083.80 	3.10 	22.20 	23799282.88 	100.30 	2289.70 	535.18 	2200.84 	4273.00 	100.91 
11.58 	46.05 	1977.00 	172.00 	1154292.67 	2.10 	26.50 	23881968.98 	100.10 	2302.30 	309.40 	3030.93 	4097.00 	100.69 
11.46 	44.59 	1855.00 	107.00 	1235273.50 	3.90 	39.10 	26338347.72 	100.00 	2384.00 	537.93 	3638.40 	4034.00 	101.10 
11.82 	47.11 	1844.00 	126.00 	1010408.90 	8.40 	46.70 	24342317.23 	99.90 	2447.70 	274.29 	4255.77 	3926.00 	101.00 
15.61 	42.58 	1911.00 	156.00 	819126.90 	10.30 	29.80 	25181475.68 	100.00 	2428.40 	318.48 	5146.65 	4155.00 	101.60 
14.67 	49.86 	1861.00 	221.00 	743200.58 	3.90 	22.90 	22742438.00 	100.00 	2464.00 	589.33 	6015.33 	4022.00 	101.94 
15.90 	49.85 	1774.00 	168.00 	1211562.81 	10.40 	41.40 	23496300.60 	100.30 	2461.70 	291.24 	6910.33 	4092.00 	102.05 
15.61 	30.50 	2029.00 	137.00 	864848.85 	6.60 	50.40 	28113774.07 	100.40 	2279.10 	347.94 	7888.69 	3038.27 	102.07 
14.15 	34.27 	1155.00 	133.20 	598585.27 	4.15 	29.33 	25209241.40 	100.20 	2359.42 	823.96 	2178.35 	3704.00 	102.89 
14.15 	34.27 	1089.00 	133.20 	677567.36 	4.15 	36.28 	21796372.27 	100.10 	2286.00 	334.86 	549.80 	3388.00 	101.10 
16.11 	32.46 	1233.00 	162.00 	1016840.13 	7.80 	33.90 	29008699.71 	100.10 	2320.60 	345.18 	1226.07 	3654.00 	100.97 
15.32 	38.50 	1805.00 	138.00 	824369.82 	0.30 	20.10 	24035151.94 	99.80 	2383.90 	633.40 	1773.75 	3943.00 	101.85 
12.73 	31.84 	1801.00 	90.00 	748386.86 	1.10 	23.40 	27311110.72 	99.90 	2400.80 	532.65 	2352.43 	3916.00 	102.46 
16.04 	32.92 	2036.00 	159.00 	782623.08 	7.40 	26.00 	28261942.49 	99.60 	2405.80 	358.57 	3259.21 	3833.00 	102.50 
];

%找出训练数据和预测数据
input_train=beijing_data(1:48,:)';
output_train=beijing_data(49:60,:)';
input_test=beijing_data(13:60,:)';
output_test=beijing_data(61:72,:)';

%选连样本输入输出数据归一化
[inputn,inputps]=mapminmax(input_train);
[outputn,outputps]=mapminmax(output_train);

inputn=inputn';
outputn=outputn';

%% BP网络训练
% %初始化网络结构
net=newff(inputn,outputn,5);

net.trainParam.epochs=100;
net.trainParam.lr=0.1;
net.trainParam.goal=0.00004;

%网络训练
net=train(net,inputn,outputn);

%% BP网络预测
inputn=inputn';
outputn=outputn';

%预测数据归一化
inputn_test=mapminmax('apply',input_test,inputps);

%网络预测输出
inputn_test=inputn_test';
an=sim(net,inputn_test);
 
%网络输出反归一化

an=an';
BPoutput=mapminmax('reverse',an,outputps);

%% 结果分析

figure(1)
plot(BPoutput,':og')
hold on
plot(output_test,'-*');
legend('预测输出','期望输出')
title('BP网络预测输出','fontsize',12)
ylabel('函数输出','fontsize',12)
xlabel('样本','fontsize',12)
%预测误差
error=BPoutput-output_test;


figure(2)
plot(error,'-*')
title('BP网络预测误差','fontsize',12)
ylabel('误差','fontsize',12)
xlabel('样本','fontsize',12)

figure(3)
plot((output_test-BPoutput)./BPoutput,'-*');
title('神经网络预测误差百分比')

errorsum=sum(abs(error));

